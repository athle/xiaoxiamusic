# 播放位置保存与恢复功能说明

## 功能概述
实现了应用划至后台时自动保存当前播放位置，再次打开应用时恢复播放位置的功能。

## 实现原理

### 1. 位置保存时机
- **应用进入后台**：在`MainActivity.onPause()`中保存
- **应用完全退出**：在`MainActivity.onDestroy()`中保存
- **服务销毁**：在`MusicService.onDestroy()`中保存

### 2. 保存内容
- 当前播放歌曲索引
- 播放位置（毫秒）
- 播放状态（播放/暂停）
- 歌曲列表信息
- 最后播放时间

### 3. 恢复机制
- **应用启动时**：在`MusicService.onCreate()`中调用`restorePlaybackState()`
- **界面加载后**：在`MainActivity.loadSavedData()`中恢复UI状态
- **智能恢复**：根据保存的播放状态决定是否自动开始播放

## 使用方法

### 自动保存
无需手动操作，当用户执行以下操作时自动触发：
1. 按Home键将应用划至后台
2. 切换到其他应用
3. 关闭应用

### 恢复播放
1. 重新打开应用
2. 如果之前正在播放，会自动从保存位置继续播放
3. 如果之前是暂停状态，会定位到保存位置等待用户点击播放

## 技术细节

### 关键代码位置
- **MusicService.kt**: `savePlaybackState()`, `restorePlaybackState()`
- **MainActivity.kt**: `onPause()`, `onDestroy()`, `loadSavedData()`
- **PreferenceHelper.kt**: 数据持久化存储

### 数据存储
使用`SharedPreferences`存储，键值包括：
- `current_song_index`: 当前歌曲索引
- `current_position`: 播放位置（毫秒）
- `is_playing`: 播放状态
- `current_song_path`: 当前歌曲路径
- `last_play_time`: 最后播放时间

## 测试验证

### 测试步骤
1. 运行 `test_playback_restore.bat` 脚本安装最新版本
2. 播放任意歌曲，记录当前播放位置
3. 按Home键将应用划至后台
4. 重新打开应用
5. 观察是否恢复到之前的位置
6. 点击播放按钮确认功能正常

### 预期结果
- 应用重新打开后显示上次播放的歌曲和位置
- 播放按钮可正常控制播放/暂停
- 进度条显示正确的播放进度

## 注意事项
- 支持Android 4.4及以上版本
- 兼容不同屏幕尺寸的设备
- 在后台时仍保持播放状态同步
- 电量优化模式下仍可正常工作

## 故障排查

### 常见问题
1. **位置未保存**：检查是否有存储权限
2. **恢复失败**：查看Logcat中的`MusicService`和`MainActivity`日志
3. **播放异常**：确认音频文件路径是否有效

### 调试信息
日志标签：
- `MusicService`: 服务相关日志
- `MainActivity`: 界面相关日志
- 搜索关键词：`"保存播放"`、`"恢复播放"`