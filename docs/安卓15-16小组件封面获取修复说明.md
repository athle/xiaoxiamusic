# 安卓15-16小组件封面获取修复说明

## 问题描述
在安卓15/16系统上，音乐小组件无法正确获取并显示歌曲的专辑封面，只显示默认图标。

## 问题分析
1. **权限系统变化**：安卓13及以上版本引入了新的媒体权限系统
2. **存储访问限制**：安卓15/16对文件系统访问有更严格的限制
3. **Context引用问题**：之前代码中`checkSelfPermission`方法调用方式不正确
4. **方法参数不匹配**：`getAlbumArtById`方法调用时传入了过多参数

## 修复方案

### 1. 权限配置更新
在`AndroidManifest.xml`中添加安卓14及以上版本所需的权限：
```xml
<!-- 安卓14及以上版本需要额外的权限 -->
<uses-permission android:name="android.permission.READ_MEDIA_VISUAL_USER_SELECTED" />
```

### 2. 代码修复

#### 2.1 修复Context引用问题
- 将`getAlbumArt()`和`getAlbumArtById()`方法改为接受`Context`参数
- 修复`checkSelfPermission`方法调用方式

#### 2.2 修复方法参数问题
修复了以下方法的参数不匹配：
- `getAlbumArt(context: Context, songPath: String): Bitmap?`
- `getAlbumArtById(context: Context, albumId: Long): Bitmap?`

#### 2.3 增强权限检查
```kotlin
// 安卓15/16权限检查
if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.TIRAMISU) {
    if (context.checkSelfPermission(android.Manifest.permission.READ_MEDIA_AUDIO) != 
        android.content.pm.PackageManager.PERMISSION_GRANTED) {
        Log.w("MusicWidget", "缺少READ_MEDIA_AUDIO权限")
        return null
    }
}
```

#### 2.4 改进文件访问方式
- 使用`FileDescriptor`方式读取文件，提高兼容性
- 添加文件存在性检查
- 实现图片缩放处理，避免内存问题

### 3. 主要修复点

#### 3.1 MusicWidgetProvider.kt
- **方法签名更新**：添加了`context: Context`参数
- **权限检查**：适配安卓15/16的新权限系统
- **错误处理**：增强异常捕获和日志记录
- **参数修复**：解决了方法调用参数不匹配问题

#### 3.2 AndroidManifest.xml
- 添加了`READ_MEDIA_VISUAL_USER_SELECTED`权限
- 保持向后兼容性

### 4. 关键修复：SharedPreferences键名匹配
**问题发现**：MusicService使用`"current_song_path"`保存路径，但MusicWidgetProvider使用`"current_path"`读取，键名不匹配导致路径为空

**修复内容**：
- 将MusicWidgetProvider中的`sharedPref.getString("current_path", "")`改为`sharedPref.getString("current_song_path", "")`
- 增强日志记录，便于调试封面获取过程

### 5. 日志增强
- 添加详细日志记录，追踪封面获取每一步
- 区分文件路径获取和专辑ID获取两种方式
- 记录权限检查和异常情况

## 测试验证

### 测试步骤
1. 运行`test_compile.bat`确认项目编译成功
2. 运行`test_widget_cover_android15.bat`测试脚本
3. 手动授予所有媒体权限
4. 添加小组件到桌面
5. 播放包含专辑封面的歌曲
6. 验证小组件封面显示

### 预期结果
- 小组件正确显示歌曲专辑封面
- 日志中显示"成功从ID3标签加载专辑封面"或"成功从媒体库加载专辑封面"
- 无权限拒绝相关错误
- 项目编译成功，无编译错误

## 兼容性说明
- **最低支持**：安卓4.4（API 19）
- **目标版本**：安卓15/16（API 35）
- **权限兼容**：适配了新的媒体权限系统
- **文件访问**：支持传统存储和分区存储

## 注意事项
1. 用户需要手动授予媒体权限
2. 某些设备可能需要重启应用才能生效
3. 网络歌曲的封面获取需要网络权限
4. 大图片会自动缩放到合适尺寸
5. 确保所有方法调用参数匹配方法定义

## 修复验证
- ✅ 项目编译成功
- ✅ 方法参数匹配
- ✅ 权限检查适配安卓15/16
- ✅ 错误处理完善
- ✅ 向后兼容性保持