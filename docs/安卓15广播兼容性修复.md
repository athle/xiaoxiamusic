# 安卓15广播兼容性修复说明

## 问题分析

应用在安卓15上启动时出现新的错误：
```
java.lang.SecurityException: com.maka.xiaoxia: One of RECEIVER_EXPORTED or RECEIVER_NOT_EXPORTED should be specified when a receiver isn't being registered exclusively for system broadcasts
```

## 根本原因

从安卓14（API级别34）开始，Google加强了对广播接收器的安全要求：
- 当应用注册广播接收器时，必须明确指定`RECEIVER_EXPORTED`或`RECEIVER_NOT_EXPORTED`标志
- 这个要求适用于所有非系统广播的注册
- 不指定标志会导致`SecurityException`异常

## 修复措施

### 1. 广播接收器注册修复
在`MainActivity.kt`的`registerBroadcastReceiver()`方法中添加了安卓14+的兼容性处理：

```kotlin
// 安卓14+需要指定RECEIVER_EXPORTED或RECEIVER_NOT_EXPORTED
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
    registerReceiver(uiUpdateReceiver, filter, Context.RECEIVER_NOT_EXPORTED)
} else {
    registerReceiver(uiUpdateReceiver, filter)
}
```

### 2. 标志选择说明
- **RECEIVER_NOT_EXPORTED**：广播接收器不导出，其他应用无法发送广播到此接收器
- **RECEIVER_EXPORTED**：广播接收器导出，其他应用可以发送广播到此接收器

选择`RECEIVER_NOT_EXPORTED`是因为当前广播仅用于应用内部通信。

## 兼容性说明

- **安卓4.4-13**：使用原有的注册方式，不受影响
- **安卓14+**：使用新的带标志的注册方式
- **向后兼容**：所有修改都保持对低版本安卓的完全兼容

## 验证步骤

1. 在安卓15设备上测试应用启动
2. 确认广播接收器正常工作
3. 验证UI更新功能正常
4. 测试播放控制功能
5. 确认低版本设备不受影响

## 技术细节

- **API级别**：使用`Build.VERSION_CODES.TIRAMISU`（API 33）作为判断条件
- **异常处理**：保持原有的异常捕获机制
- **注册时机**：在`onCreate`中延迟注册，确保UI线程有足够时间

## 后续监控

- 监控广播接收器的注册和注销
- 关注用户反馈的广播相关问题
- 如有需要，可考虑升级到更高版本的AppCompat库