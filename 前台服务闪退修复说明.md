# 前台服务闪退修复说明

## 问题描述
应用在横竖屏切换时出现闪退，错误日志显示：
```
android.app.RemoteServiceException$ForegroundServiceDidNotStartInTimeException: 
Context.startForegroundService() did not then call Service.startForeground()
```

## 问题原因
从Android 8.0（API 26）开始，使用`startForegroundService()`启动的服务必须在5秒内调用`startForeground()`方法，否则会抛出`ForegroundServiceDidNotStartInTimeException`异常。

MusicService虽然使用了`startForegroundService()`启动，但没有实现前台服务通知，导致系统强制停止服务。

## 修复方案

### 1. 添加前台服务通知支持
在MusicService中实现了以下功能：
- 创建通知渠道（Android 8.0+）
- 启动前台服务通知
- 播放控制按钮集成
- 动态更新通知内容

### 2. 代码修改

#### 新增导入
```kotlin
import android.app.Notification
import android.app.NotificationChannel
import android.app.NotificationManager
import android.app.PendingIntent
import android.os.Build
```

#### 新增常量
```kotlin
private const val NOTIFICATION_CHANNEL_ID = "music_service_channel"
private const val NOTIFICATION_ID = 1
```

#### 新增方法
- `createNotificationChannel()`: 创建通知渠道
- `startForegroundNotification()`: 启动前台服务通知
- `updateNotification()`: 更新通知内容

#### 关键修改
- 在`onStartCommand()`中调用`startForegroundNotification()`
- 在播放状态变化时调用`updateNotification()`
- 兼容Android 8.0以下版本

### 3. 资源文件
创建了`ic_notification.xml`作为通知图标。

## 验证步骤

### 自动测试
运行`test_foreground_service.bat`脚本：
1. 清理构建缓存
2. 重新构建项目
3. 安装应用
4. 启动应用
5. 检查前台服务状态
6. 验证日志输出

### 手动测试
1. 启动应用
2. 点击播放按钮
3. 观察是否出现前台通知
4. 旋转屏幕，检查是否闪退
5. 验证通知控制功能（播放/暂停、上一首、下一首）

## 预期效果
- 应用不再因前台服务超时而闪退
- 显示音乐播放通知
- 通知栏可直接控制播放
- 横竖屏切换正常
- 兼容Android 4.4到最新版本

## 注意事项
- 通知渠道名称和描述已本地化为中文
- 通知重要性设置为LOW，避免打扰用户
- 兼容旧版本Android系统
- 通知图标使用应用主题色

## 相关文件
- `MusicService.kt`: 主要修复文件
- `ic_notification.xml`: 通知图标
- `test_foreground_service.bat`: 测试脚本